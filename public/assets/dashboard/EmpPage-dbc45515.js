import{_ as A,z as M,o as a,c as s,b as t,i as D,j as x,q as L,t as m,e as g,p as F,f as B,u as O,a as N,l as I,r as w,d as b,g as S,m as E,v as T,h as V}from"./index-92b4f33c.js";import{v as $}from"./validationMsgs-754c5d91.js";import{u as z}from"./employees-70716d82.js";import{d as H}from"./excelMaker-9fd49c90.js";const U=n=>(F("data-v-44205386"),n=n(),B(),n),Y={class:"table table-borderless overflow-x-auto"},W=U(()=>t("thead",{class:"bg-color-main"},[t("tr",null,[t("th",{scope:"col",class:"bg-transparent text-white text-center px-3"},"احد"),t("th",{scope:"col",class:"bg-transparent text-white text-center px-3"},"اثنين"),t("th",{scope:"col",class:"bg-transparent text-white text-center px-3"},"ثلاثاء"),t("th",{scope:"col",class:"bg-transparent text-white text-center px-3"},"اربعاء"),t("th",{scope:"col",class:"bg-transparent text-white text-center px-3"},"خميس"),t("th",{scope:"col",class:"bg-transparent text-white text-center px-3"},"جمعة"),t("th",{scope:"col",class:"bg-transparent text-white text-center px-3"},"سبت")])],-1)),j={class:"d-flex align-items-center"},q={class:L("day")},P={key:0},Z={__name:"Calendar",props:{year:Number,month:Number,events:Array},setup(n){const d=n,p=M(()=>{const _=[],c=new Date(d.year,d.month+1,0).getDate();let u=[null,null,null,null,null,null,null];for(let l=1;l<=c;l++){const h=new Date(d.year,d.month,l);u[h.getDay()]={date:h,events:d.events.filter(f=>new Date(f.day).getDate()===h.getDate())},(h.getDay()===6||l===c)&&(_.push(u),u=[])}return _});function e(_){const o=new Date(_);if(isNaN(o.getTime()))return"Invalid date";const c=o.getHours(),u=o.getMinutes(),l=c%12||12,h=c<12?"صباحاً":"مساءً",f=u<10?"0"+u:u;return`${l}:${f} ${h}`}return(_,o)=>(a(),s("table",Y,[W,t("tbody",null,[(a(!0),s(D,null,x(p.value,(c,u)=>(a(),s("tr",{key:u},[(a(!0),s(D,null,x(c,(l,h)=>(a(),s("td",{key:h,class:L(`day-td px-3 border-1 ${(l==null?void 0:l.events.length)>0?"active":""}`)},[t("div",j,[t("span",q,m(l==null?void 0:l.date.getDate()),1)]),(l==null?void 0:l.events.length)>0?(a(),s("p",P," الوقت: "+m(e(l==null?void 0:l.events[0].attended_at)),1)):g("",!0)],2))),128))]))),128))])]))}},G=A(Z,[["__scopeId","data-v-44205386"]]);const J=(n,d,p)=>{const e=[],o=new Date(n,d+1,0).getDate();let c=[null,null,null,null,null,null,null];for(let u=1;u<=o;u++){const l=new Date(n,d,u);c[l.getDay()]={date:l,events:p.filter(h=>new Date(h.day).getDate()===l.getDate())},(l.getDay()===6||u===o)&&(e.push(c),c=[])}return e},K={data:()=>({authStore:O(),empsStore:z(),fetching:!1,settingAttendance:!1,availableAbilities:N}),computed:{emp(){return this.empsStore.$state.employees.find(n=>n.id.toString()===this.$route.params.id)},loadedEmp(){return this.empsStore.$state.loaded.find(n=>n.id.toString()===this.$route.params.id)}},methods:{fetchEmp(){this.fetching=!0,this.empsStore.load(this.$route.params.id).catch(()=>{this.$swal.fire({icon:"error",title:"يوجد خطأ بالشبكة.",showConfirmButton:!1,cancelButtonText:"إغلاق"})}).finally(()=>this.fetching=!1)},addDiscount(n,d){n.preventDefault();const p=parseFloat(n.target.amount.value),e=n.target.reason.value,_=new Date().toISOString();!p||!e||(d.discounts.push({amount:p,reason:e,date:_}),n.target.amount.value="",n.target.reason.value="")},saveFee(n){n.updating=!0,this.empsStore.updateFees(this.emp.id,n).then(()=>{this.$swal.fire({icon:"success",title:"تم الحفظ",showCancelButton:!1,showConfirmButton:!1})}).catch(()=>{this.$swal.fire({icon:"error",title:"خطأ فى الشبكة.",showConfirmButton:!1})}).finally(()=>n.updating=!1)},convertTime(n){const d=new Date(n);if(isNaN(d.getTime()))return"Invalid date";const p=d.getHours(),e=d.getMinutes(),_=p%12||12,o=p<12?"صباحاً":"مساءً",c=e<10?"0"+e:e;return`${_}:${c} ${o}`},setAttendance(){this.settingAttendance=!0,this.empsStore.setAttendance(this.loadedEmp.id).then(()=>{this.loadedEmp.attendance.push({day:new Date().toISOString(),attended_at:new Date().toISOString()})}).catch(()=>{this.$swal.fire({icon:"error",title:"يوجد خطأ بالشبكة.",showConfirmButton:!1,cancelButtonText:"إغلاق"})}).finally(()=>this.settingAttendance=!1)},exportExeclSheet(n){const d=J(new Date(n.month).getFullYear(),new Date(n.month).getMonth(),this.loadedEmp.attendance.filter(e=>new Date(e.day).getMonth()===new Date(n.month).getMonth())),p=n.discounts;H(this.loadedEmp.name,[d,p],[[{column:"الأحد",type:String,value:e=>e[0]?`${e[0].date.getDate()} ${e[0].events[0]?" ("+new Date(e[0].events[0].attended_at).toLocaleTimeString()+")":""}`:null,width:30,align:"center"},{column:"الأثنين",type:String,value:e=>e[1]?`${e[1].date.getDate()} ${e[1].events[0]?" ("+new Date(e[1].events[0].attended_at).toLocaleTimeString()+")":""}`:null,width:30,align:"center"},{column:"الثلاثاء",type:String,value:e=>e[2]?`${e[2].date.getDate()} ${e[2].events[0]?" ("+new Date(e[2].events[0].attended_at).toLocaleTimeString()+")":""}`:null,width:30,align:"center"},{column:"الأربعاء",type:String,value:e=>e[3]?`${e[3].date.getDate()} ${e[3].events[0]?" ("+new Date(e[3].events[0].attended_at).toLocaleTimeString()+")":""}`:null,width:30,align:"center"},{column:"الخميس",type:String,value:e=>e[4]?`${e[4].date.getDate()} ${e[4].events[0]?" ("+new Date(e[4].events[0].attended_at).toLocaleTimeString()+")":""}`:null,width:30,align:"center"},{column:"الجمعة",type:String,value:e=>e[5]?`${e[5].date.getDate()} ${e[5].events[0]?" ("+new Date(e[5].events[0].attended_at).toLocaleTimeString()+")":""}`:null,width:30,align:"center"},{column:"السبت",type:String,value:e=>e[6]?`${e[6].date.getDate()} ${e[6].events[0]?" ("+new Date(e[6].events[0].attended_at).toLocaleTimeString()+")":""}`:null,width:30,align:"center"}],[{column:"قيمة الخصم",type:String,value:e=>`${e.amount}ج`,width:30,align:"center"},{column:"السبب",type:String,value:e=>e.reason,width:30,align:"center"},{column:"التاريخ",type:String,value:e=>new Date(e.date).toLocaleDateString(),width:30,align:"center"}]],["الحضور","الخصومات"])}},watch:{empForm:{handler(n){!/^[a-zA-Z\u0621-\u064A\ ]{2,100}$/.test(n.name)&&n.name?this.formErrors.name=$.name:delete this.formErrors.name,n.salary?parseFloat(n.salary)>=999999.99||parseFloat(n.salary)<1?this.formErrors.salary=$.salary:delete this.formErrors.salary:this.formErrors.salary=$.salary},deep:!0}},mounted(){this.authStore.can(this.availableAbilities.employees.index)||this.$router.push({name:"home"}),this.loadedEmp||this.fetchEmp()},components:{LoadingComponent:I,Calendar:G}},Q={class:"position-absolute top-0 w-100 h-100 z-2 bg-body overflow-y-auto"},R={class:"container my-3"},X={class:"row mb-4"},tt={class:"col-12"},et={class:"d-flex align-items-center"},nt={key:0,class:"row mt-5"},at={class:"col-12 overflow-x-auto pb-3 mb-4 border-bottom"},st=t("h6",null,"حضور اليوم",-1),ot={key:0},lt={key:1},it=t("p",null,"لم يتم تسجيل الحضور اليوم.",-1),rt=["disabled"],ct={key:1},dt={class:"col-12 overflow-x-auto"},ut=t("h6",{class:"mb-3"},"سجل الأشهر",-1),ht={class:"accordion",id:"fees"},pt={class:"accordion-header"},mt=["data-bs-target"],_t=["id"],gt={class:"accordion-body"},bt={key:0,class:"info mb-4 pb-2 border-bottom"},ft=t("b",null,"الراتب",-1),vt=t("b",null,"مجموع الخصومات",-1),yt=t("b",null,"الباقى بعد الخصم",-1),Dt={key:1,class:"info mb-4 pb-2 text-left"},xt=["onClick"],wt={class:"ico"},St=t("span",{style:{"margin-right":"7px"}}," إستخراج الى ملف اكسل ",-1),$t={class:"mb-4 pb-2 border-bottom"},Ct=t("h5",null,"أيام الحضور",-1),kt=t("h5",null,"الخصومات",-1),Et={class:"table table-borderless border-bottom overflow-x-auto"},Tt=t("thead",{class:"bg-color-main"},[t("tr",null,[t("th",{scope:"col",class:"bg-transparent text-white px-3"},"قيمة الخصم"),t("th",{scope:"col",class:"bg-transparent text-white px-3"},"السبب"),t("th",{scope:"col",class:"bg-transparent text-white px-3"},"التاريخ"),t("th",{scope:"col",class:"bg-transparent text-white px-3"})])],-1),At={class:"px-3"},Lt=["onUpdate:modelValue"],Mt={key:1},Ft={class:"px-3"},Bt=["onUpdate:modelValue"],Ot={key:1},Nt={class:"px-3"},It={class:"px-3"},Vt={key:0},zt=["onClick"],Ht=["onClick"],Ut={key:1},Yt=["onClick"],Wt={key:2,class:"border-bottom pb-3"},jt=t("b",null,"إضافة خصم",-1),qt=t("br",null,null,-1),Pt=["onSubmit"],Zt=t("input",{type:"number",name:"amount",class:"form-control",placeholder:"قيمة الخصم",style:{width:"200px","margin-left":"5px","margin-top":"5px"}},null,-1),Gt=t("input",{type:"text",name:"reason",class:"form-control",placeholder:"السبب",style:{width:"200px","margin-top":"5px","margin-left":"5px"}},null,-1),Jt={type:"submit",class:"btn btn-primary",style:{"margin-top":"5px"}},Kt=t("span",{style:{"margin-right":"5px"}},"إضافة",-1),Qt={key:3,class:"d-flex justify-content-end mt-3"},Rt=["onClick","disabled"],Xt={key:1},te=t("span",{style:{"margin-right":"5px"}},"حفظ",-1);function ee(n,d,p,e,_,o){var h,f;const c=w("font-awesome-icon"),u=w("LoadingComponent"),l=w("Calendar");return a(),s("div",Q,[t("div",R,[t("div",X,[t("div",tt,[t("h5",et,[b(c,{icon:"fa-solid fa-user-tie",style:{"font-size":"34px","margin-left":"15px"}}),t("span",null,m(((h=o.emp)==null?void 0:h.name)||((f=o.loadedEmp)==null?void 0:f.name)),1),n.fetching?(a(),S(u,{key:0,style:{"margin-right":"15px"},width:"28px"})):g("",!0)])])]),o.loadedEmp?(a(),s("div",nt,[t("div",at,[st,o.loadedEmp.attendance.filter(r=>new Date(r.day).toLocaleDateString()===new Date().toLocaleDateString()).length>0?(a(),s("p",ot," تم تسجيل الحضور فى: "+m(o.convertTime(o.loadedEmp.attendance.filter(r=>new Date(r.day).toLocaleDateString()===new Date().toLocaleDateString())[0].attended_at)),1)):(a(),s("div",lt,[it,n.authStore.can(n.availableAbilities.employees.update)?(a(),s("button",{key:0,class:"btn btn-success",disabled:n.settingAttendance,onClick:d[0]||(d[0]=(...r)=>o.setAttendance&&o.setAttendance(...r))},[n.settingAttendance?(a(),S(u,{key:0,width:"20px"})):(a(),s("span",ct," تسجيل حضور الأن "))],8,rt)):g("",!0)]))]),t("div",dt,[ut,t("div",ht,[(a(!0),s(D,null,x([...o.loadedEmp.fees].reverse(),r=>{var C,k;return a(),s("div",{class:"accordion-item",key:r.id},[t("h2",pt,[t("button",{class:"accordion-button collapsed",type:"button","data-bs-toggle":"collapse","data-bs-target":`#fee-${r.id}`,"aria-expanded":"false","aria-controls":"collapseTwo"},m(new Date(r.month).getMonth()+1)+"/"+m(new Date(r.month).getFullYear()),9,mt)]),t("div",{id:`fee-${r.id}`,class:"accordion-collapse collapse","data-bs-parent":"#fees"},[t("div",gt,[n.authStore.$state.user.abilities.indexOf("*")>-1?(a(),s("div",bt,[t("div",null,[ft,t("span",null,": "+m((C=o.emp)==null?void 0:C.salary)+"ج",1)]),t("div",null,[vt,t("span",null,": "+m(r.discounts.reduce((i,v)=>i+=v.amount,0))+"ج",1)]),t("div",null,[yt,t("span",null,": "+m(((k=o.emp)==null?void 0:k.salary)-r.discounts.reduce((i,v)=>i+=v.amount,0))+"ج",1)])])):g("",!0),n.authStore.$state.user.abilities.indexOf("*")>-1?(a(),s("div",Dt,[t("button",{class:"btn btn-excel color-main",onClick:()=>o.exportExeclSheet(r)},[t("span",wt,[b(c,{icon:"fa-solid fa-file-excel"})]),St],8,xt)])):g("",!0),t("div",$t,[Ct,b(l,{year:new Date(r.month).getFullYear(),month:new Date(r.month).getMonth(),events:o.loadedEmp.attendance.filter(i=>new Date(i.day).getMonth()===new Date(r.month).getMonth())},null,8,["year","month","events"])]),kt,t("table",Et,[Tt,t("tbody",null,[(a(!0),s(D,null,x(r.discounts,(i,v)=>(a(),s("tr",{key:v},[t("td",At,[i.edit?E((a(),s("input",{key:0,type:"number","onUpdate:modelValue":y=>i.amount=y,name:"amount",class:"form-control",placeholder:"قيمة الخصم"},null,8,Lt)),[[T,i.amount]]):(a(),s("span",Mt,m(i.amount)+"ج ",1))]),t("td",Ft,[i.edit?E((a(),s("input",{key:0,type:"text","onUpdate:modelValue":y=>i.reason=y,name:"reason",class:"form-control",placeholder:"السبب"},null,8,Bt)),[[T,i.reason]]):(a(),s("span",Ot,m(i.reason),1))]),t("td",Nt,m(i.date?`${new Date(i.date).getDate()}/${new Date(i.date).getMonth()+1}/${new Date(i.date).getFullYear()}`:"لم يتم التسجيل"),1),t("td",It,[i.edit?(a(),s("div",Ut,[n.authStore.$state.user.abilities.indexOf("*")>-1?(a(),s("button",{key:0,class:"btn btn-success",onClick:y=>delete i.edit},[b(c,{icon:"fa-solid fa-check"})],8,Yt)):g("",!0)])):(a(),s("div",Vt,[n.authStore.$state.user.abilities.indexOf("*")>-1?(a(),s("button",{key:0,class:"btn btn-primary",onClick:y=>i.edit=!0},[b(c,{icon:"fa-solid fa-pen-to-square"})],8,zt)):g("",!0),n.authStore.$state.user.abilities.indexOf("*")>-1?(a(),s("button",{key:1,class:"btn btn-danger",style:{"margin-right":"5px"},onClick:y=>r.discounts.splice(v,1)},[b(c,{icon:"fa-solid fa-trash"})],8,Ht)):g("",!0)]))])]))),128))])]),n.authStore.can(n.availableAbilities.employees.update)?(a(),s("div",Wt,[jt,V(),qt,t("form",{class:"d-flex flex-wrap align-items-center",onSubmit:i=>o.addDiscount(i,r)},[Zt,Gt,t("button",Jt,[b(c,{icon:"fa-solid fa-plus"}),Kt])],40,Pt)])):g("",!0),n.authStore.can(n.availableAbilities.employees.update)?(a(),s("div",Qt,[t("button",{class:"btn btn-success",onClick:i=>o.saveFee(r),disabled:r.updating},[r.updating?(a(),S(u,{key:0,width:"20px"})):(a(),s("span",Xt,[b(c,{icon:"fa-solid fa-save"}),te]))],8,Rt)])):g("",!0)])],8,_t)])}),128))])])])):g("",!0)])])}const le=A(K,[["render",ee]]);export{le as default};
